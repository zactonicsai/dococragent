<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocScan ‚Äî Upload & Extract</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          },
          colors: {
            ink: '#1a1a2e',
            paper: '#faf9f6',
            accent: '#e85d04',
            muted: '#6b7280',
            surface: '#f0ede8',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'DM Sans', sans-serif; background: #faf9f6; }
    .drop-active { border-color: #e85d04 !important; background: #fef3e8 !important; }
    @keyframes pulse-border { 0%,100%{border-color:#d1d5db} 50%{border-color:#e85d04} }
    .uploading { animation: pulse-border 1.5s ease-in-out infinite; }
    @keyframes slideUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
    .slide-up { animation: slideUp .4s ease-out; }
    .progress-fill { transition: width .3s ease; }
  </style>
</head>
<body class="min-h-screen bg-paper text-ink">

  <!-- Nav -->
  <nav class="border-b border-gray-200 bg-white/60 backdrop-blur-sm sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-6 h-14 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 text-lg font-bold tracking-tight">
        <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 3v5a2 2 0 002 2h4"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6M9 17h4"/>
        </svg>
        DocScan
      </a>
      <a href="/files.html" class="text-sm font-medium text-muted hover:text-ink transition-colors px-3 py-1.5 rounded-md hover:bg-surface">
        Browse Files ‚Üí
      </a>
    </div>
  </nav>

  <main class="max-w-3xl mx-auto px-6 py-16">

    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold tracking-tight mb-3">Upload & Extract</h1>
      <p class="text-muted text-lg max-w-md mx-auto leading-relaxed">
        Drop a document or image. If it's an image or PDF, we'll run OCR to extract the text automatically.
      </p>
    </div>

    <!-- Drop Zone -->
    <div
      id="dropZone"
      class="relative border-2 border-dashed border-gray-300 rounded-2xl p-16 text-center cursor-pointer transition-all duration-200 hover:border-accent hover:bg-orange-50/30 group"
      onclick="document.getElementById('fileInput').click()"
    >
      <input type="file" id="fileInput" class="hidden" accept="*/*">

      <div id="dropContent">
        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-surface flex items-center justify-center group-hover:bg-orange-100 transition-colors">
          <svg class="w-8 h-8 text-muted group-hover:text-accent transition-colors" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
          </svg>
        </div>
        <p class="text-lg font-medium mb-1">Drop your file here</p>
        <p class="text-muted text-sm">or click to browse ‚Äî images, PDFs, documents up to 50 MB</p>
      </div>

      <!-- Progress (hidden by default) -->
      <div id="progressArea" class="hidden">
        <div class="w-12 h-12 mx-auto mb-4 rounded-xl bg-orange-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-accent animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
          </svg>
        </div>
        <p id="progressText" class="text-sm font-medium mb-3">Uploading‚Ä¶</p>
        <div class="w-full max-w-xs mx-auto bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="progress-fill h-2 rounded-full bg-accent" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="resultArea" class="hidden mt-8 slide-up"></div>

    <!-- Error -->
    <div id="errorArea" class="hidden mt-6 slide-up"></div>

  </main>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropContent = document.getElementById('dropContent');
    const progressArea = document.getElementById('progressArea');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultArea = document.getElementById('resultArea');
    const errorArea = document.getElementById('errorArea');

    // ‚îÄ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ
    ['dragenter','dragover'].forEach(e => {
      dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('drop-active'); });
    });
    ['dragleave','drop'].forEach(e => {
      dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.remove('drop-active'); });
    });
    dropZone.addEventListener('drop', (e) => {
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    // ‚îÄ‚îÄ‚îÄ File type helpers ‚îÄ‚îÄ‚îÄ
    function getFileCategory(mimeType, filename) {
      if (!mimeType) return { label: 'Unknown', color: 'gray', icon: 'üìÑ' };
      if (mimeType.startsWith('image/')) return { label: 'Image', color: 'green', icon: 'üñºÔ∏è' };
      if (mimeType === 'application/pdf') return { label: 'PDF', color: 'red', icon: 'üìï' };
      if (mimeType.includes('word') || filename.match(/\.docx?$/i)) return { label: 'Word Doc', color: 'blue', icon: 'üìù' };
      if (mimeType.includes('sheet') || mimeType.includes('excel') || filename.match(/\.xlsx?$/i)) return { label: 'Spreadsheet', color: 'emerald', icon: 'üìä' };
      if (mimeType.includes('text')) return { label: 'Text', color: 'yellow', icon: 'üìÉ' };
      return { label: 'Document', color: 'purple', icon: 'üìÑ' };
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // ‚îÄ‚îÄ‚îÄ Upload handler ‚îÄ‚îÄ‚îÄ
    async function handleFile(file) {
      // Reset UI
      resultArea.classList.add('hidden');
      errorArea.classList.add('hidden');
      dropContent.classList.add('hidden');
      progressArea.classList.remove('hidden');
      dropZone.classList.add('uploading');
      progressBar.style.width = '0%';
      progressText.textContent = 'Uploading‚Ä¶';

      const formData = new FormData();
      formData.append('document', file);

      try {
        // Simulate progress for UX
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 15, 85);
          progressBar.style.width = progress + '%';
        }, 300);

        progressText.textContent = 'Uploading & analyzing‚Ä¶';

        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Upload failed');
        }

        const data = await response.json();
        progressText.textContent = 'Complete!';

        setTimeout(() => showResult(data.file), 500);
      } catch (err) {
        showError(err.message);
      } finally {
        dropZone.classList.remove('uploading');
        setTimeout(() => {
          dropContent.classList.remove('hidden');
          progressArea.classList.add('hidden');
          progressBar.style.width = '0%';
        }, 2000);
        fileInput.value = '';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Show result card ‚îÄ‚îÄ‚îÄ
    function showResult(file) {
      const cat = getFileCategory(file.mimeType, file.originalName);
      const ocrBadge = file.ocrApplied
        ? `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
             OCR Complete
           </span>`
        : file.ocrError
          ? `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">‚ö† OCR Issue</span>`
          : `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">No OCR needed</span>`;

      let textPreview = '';
      if (file.extractedText) {
        const preview = file.extractedText.substring(0, 800);
        textPreview = `
          <div class="mt-5 pt-5 border-t border-gray-100">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-muted uppercase tracking-wider">Extracted Text</h3>
              <span class="text-xs text-muted">${file.extractedText.length.toLocaleString()} chars</span>
            </div>
            <div class="bg-surface rounded-xl p-4 font-mono text-sm leading-relaxed text-gray-700 max-h-64 overflow-y-auto whitespace-pre-wrap">${escapeHtml(preview)}${file.extractedText.length > 800 ? '\n\n‚Ä¶' : ''}</div>
            ${file.textFile ? `
              <a href="/api/files/text/${file.textFile}" download
                 class="inline-flex items-center gap-1.5 mt-3 text-sm font-medium text-accent hover:text-orange-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Download text file
              </a>` : ''}
          </div>`;
      }

      resultArea.innerHTML = `
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 slide-up">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-4">
              <div class="text-3xl">${cat.icon}</div>
              <div>
                <h2 class="font-semibold text-lg leading-tight">${escapeHtml(file.originalName)}</h2>
                <div class="flex items-center gap-3 mt-1.5">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${cat.color}-100 text-${cat.color}-700">
                    ${cat.label}
                  </span>
                  <span class="text-xs text-muted">${formatSize(file.size)}</span>
                  <span class="text-xs text-muted font-mono">${file.mimeType}</span>
                </div>
              </div>
            </div>
            ${ocrBadge}
          </div>
          ${textPreview}
          <div class="mt-5 pt-4 border-t border-gray-100 flex gap-3">
            <a href="/api/files/download/${file.filename}" download
               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-ink text-white text-sm font-medium hover:bg-gray-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
              Download Original
            </a>
            <a href="/files.html"
               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium hover:bg-surface transition-colors">
              View All Files
            </a>
          </div>
        </div>`;
      resultArea.classList.remove('hidden');
    }

    function showError(message) {
      errorArea.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-xl p-5 flex items-start gap-3 slide-up">
          <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
          </svg>
          <div>
            <p class="font-medium text-red-800">Upload failed</p>
            <p class="text-sm text-red-600 mt-0.5">${escapeHtml(message)}</p>
          </div>
        </div>`;
      errorArea.classList.remove('hidden');
      dropContent.classList.remove('hidden');
      progressArea.classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
